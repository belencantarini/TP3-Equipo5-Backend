extends ../layout

block content
  .container.mt-4

  h2 Lista de Tareas


  .text-end.mb-3
    a.btn.btn-primary(href="/tareas/nuevo") Nueva Tarea
  
  if error
    .alert.alert-danger(role="alert")
    #{error}
  
          
        // -----------------------
        // 2. FORMULARIO DE FILTROS
        // -----------------------
  h4.mb-3 Filtros
        .card.p-3.mb-5
          
          form.row.g-3(action="/tareas", method="get")
            
            // FILTRO √ÅREA
            .col-md-3
              label.form-label(for="area") √Årea:
              select.form-select(name="area")
                option(value="") Todas
                each a in areas
                  option(value=a selected=(filtros.area == a))= a

            // FILTRO EMPLEADO
            .col-md-3
              label.form-label(for="empleadoId") Empleado:
              select.form-select(name="empleadoId")
                option(value="") Todos
                each e in empleados
                  option(value=e._id selected=(filtros.empleadoId == e._id))  #{e.nombre} #{e.apellido} (#{e.rol}) - DNI: #{e.dni}

            // FILTRO PACIENTE
            .col-md-3
              label.form-label(for="pacienteId") Paciente:
              select.form-select(name="pacienteId")
                option(value="") Todos
                each p in pacientes
                  option(value=p._id selected=(filtros.pacienteId == p._id))  #{p.nombre} #{p.apellido} - DNI: #{p.dni}
            
            // FILTRO ESTADO
            .col-md-3
              label.form-label(for="estado") Estado:
              select.form-select(name="estado")
                option(value="") Todos
                each est in estados
                  option(value=est selected=(filtros.estado == est))= est

            // FILTRO PRIORIDAD
            .col-md-3
              label.form-label(for="prioridad") Prioridad:
              select.form-select(name="prioridad")
                option(value="") Todas
                each pri in prioridades
                  option(value=pri selected=(filtros.prioridad == pri))= pri

            // FILTRO FECHA
            .col-md-3
              label.form-label(for="fecha") Fecha (Inicio):
              input.form-control(type="date" name="fecha" value=(filtros.fecha || ''))

            // BOTONES DE FILTRO
            .col-12.d-flex.gap-2.mt-3
              button.btn.btn-primary(type="submit") üîé Filtrar
              // 4. Quitar 'tareasmongo' del bot√≥n de limpiar
              button.btn.btn-outline-secondary(type="button", onclick="location.href='/tareas'") Limpiar filtros
        
        // -----------------------
        // 5. LISTADO (Tabla)
        // -----------------------
        
  h2 Tareas Encontradas

    if tareas && tareas.length
      each t in tareas
        .card.mb-4.mt-2.shadow-sm 
          .card-header.d-flex.justify-content-between.align-items-center
            div
              h3.fw-bold Tarea ID: #{t._id}
            div
              // Prioridad con Badge
              - let badgeClass = t.prioridad === 'alta' || t.prioridad === 'urgente' ? 'bg-danger' : t.prioridad === 'media' ? 'bg-warning text-dark' : 'bg-success';
              span.badge.me-2.fs-6(class=badgeClass) Prioridad: #{t.prioridad}
              // Estado
              span.badge.bg-primary.fs-6 Estado: #{t.estado}

          .card-body.fs-5
            .row
              
              // COLUMNA IZQUIERDA (Datos principales)
              .col-lg-6.col-12.border-end-lg 
                h4.card-title Datos Principales
                dl.row.mb-0
                  dt.col-5 √Årea:
                  dd.col-7= t.area

                  dt.col-5 Tipo:
                  dd.col-7= t.tipo || 'N/A' 
                  
                  dt.col-5 Proveedor:
                  dd.col-7= t.proveedor || 'N/A'

                  dt.col-5 Activo:
                  dd.col-7
                    span.badge(class=`${t.activo ? 'bg-success' : 'bg-secondary'}`)= t.activo ? 'S√≠' : 'No'

              // COLUMNA DERECHA (Referencias y Fechas)
              .col-lg-6.col-12
                h4.card-title Referencias y Tiempos
                dl.row.mb-0
                  // Empleado (Poblado)
                  dt.col-5 Empleado:
                  dd.col-7
                    if t.empleadoId
                      | #{t.empleadoId.nombre} #{t.empleadoId.apellido} (#{t.empleadoId.rol})
                    else
                      | N/A

                  // Paciente (Poblado)
                  dt.col-5 Paciente:
                  dd.col-7
                    if t.pacienteId
                      | #{t.pacienteId.nombre} #{t.pacienteId.apellido}
                    else
                      | N/A
                  
                  dt.col-5 Fecha Inicio:
                  dd.col-7= t.fechaInicio ? new Date(t.fechaInicio).toLocaleDateString() : 'N/A'
                  
                  dt.col-5 Fecha Fin:
                  dd.col-7= t.fechaFin ? new Date(t.fechaFin).toLocaleDateString() : 'N/A'
            
            hr.my-3 

            // OBSERVACIONES (Ancho Completo)
            h4.card-title Observaciones
            p.card-text.small= t.observaciones || 'No hay observaciones.'


          .card-footer.d-flex.gap-2.justify-content-end 
            div.d-flex.gap-2.justify-content-end
              a.btn.p-2.m-0.btn-warning(href=`/tareas/editar/${t._id}`) Editar
              form(action=`/tareas/eliminar/${t._id}?_method=DELETE`, method="post")
                button.btn.p-2.m-0.btn-danger(type="submit", onclick="return confirm('¬øEst√° seguro de que desea eliminar esta tarea?')") Eliminar

    else
      .alert.alert-info No hay tareas que coincidan con los filtros aplicados.